{"version":3,"file":"newsService-DtYqLLyP.js","sources":["../../src/services/newsService.js"],"sourcesContent":["/**\r\n * 뉴스 서비스 - RSS 피드 및 뉴스 API 연동\r\n * 정적 배포 (GitHub Pages 등) 환경 지원\r\n */\r\n\r\nimport { isStaticDeployment, DEMO_NEWS } from '../data/staticData';\r\nimport logger from '../utils/logger';\r\n\r\n// CORS 프록시 목록 (병렬로 시도)\r\nconst CORS_PROXIES = [\r\n    (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,\r\n    (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,\r\n    (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,\r\n];\r\n\r\n// 뉴스 소스 정의\r\nconst NEWS_SOURCES = {\r\n    naver: {\r\n        name: '네이버 부동산',\r\n        rssUrl: 'https://news.google.com/rss/search?q=부동산+site:naver.com&hl=ko&gl=KR&ceid=KR:ko',\r\n    },\r\n    hankyung: {\r\n        name: '한국경제',\r\n        rssUrl: 'https://news.google.com/rss/search?q=부동산+site:hankyung.com&hl=ko&gl=KR&ceid=KR:ko',\r\n    },\r\n    mk: {\r\n        name: '매일경제',\r\n        rssUrl: 'https://news.google.com/rss/search?q=부동산+site:mk.co.kr&hl=ko&gl=KR&ceid=KR:ko',\r\n    },\r\n    chosun: {\r\n        name: '조선일보',\r\n        rssUrl: 'https://news.google.com/rss/search?q=부동산+site:chosun.com&hl=ko&gl=KR&ceid=KR:ko',\r\n    },\r\n};\r\n\r\n/**\r\n * CORS 프록시를 통해 URL fetch (병렬 시도로 개선)\r\n * Promise.race로 가장 빠른 성공 응답 사용, 나머지는 취소\r\n */\r\nasync function fetchWithCorsProxy(url, timeout = 5000) {\r\n    // 모든 프록시에 대한 AbortController 생성\r\n    const controllers = CORS_PROXIES.map(() => new AbortController());\r\n\r\n    // 병렬 요청 생성\r\n    const fetchPromises = CORS_PROXIES.map((getProxyUrl, index) => {\r\n        const proxyUrl = getProxyUrl(url);\r\n        const controller = controllers[index];\r\n\r\n        return (async () => {\r\n            try {\r\n                const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n                const response = await fetch(proxyUrl, {\r\n                    signal: controller.signal,\r\n                    headers: { 'Accept': 'application/rss+xml, application/xml, text/xml' }\r\n                });\r\n                clearTimeout(timeoutId);\r\n\r\n                if (response.ok) {\r\n                    // 성공 시 다른 요청들 취소\r\n                    controllers.forEach((ctrl, i) => {\r\n                        if (i !== index) ctrl.abort();\r\n                    });\r\n                    return await response.text();\r\n                }\r\n                throw new Error(`Proxy ${index} returned ${response.status}`);\r\n            } catch (error) {\r\n                // AbortError는 정상적인 취소이므로 무시\r\n                if (error.name === 'AbortError') {\r\n                    throw error; // 취소된 요청은 다시 throw\r\n                }\r\n                logger.warn(`프록시 ${index} 실패:`, error.message);\r\n                throw error;\r\n            }\r\n        })();\r\n    });\r\n\r\n    // 첫 번째 성공 응답 반환, 모두 실패 시 에러\r\n    try {\r\n        // Promise.any: 첫 번째 성공한 Promise 반환\r\n        const result = await Promise.any(fetchPromises);\r\n        return result;\r\n    } catch (aggregateError) {\r\n        // 모든 프록시 실패\r\n        logger.error('모든 CORS 프록시 실패');\r\n        throw new Error('모든 CORS 프록시 실패');\r\n    }\r\n}\r\n\r\n/**\r\n * Google News RSS를 통해 부동산 뉴스 가져오기\r\n */\r\nexport const fetchRealEstateNews = async (category = 'all') => {\r\n    const queries = {\r\n        all: '부동산',\r\n        market: '아파트+시세',\r\n        policy: '부동산+정책',\r\n        analysis: '부동산+전망',\r\n        development: '재건축+재개발',\r\n    };\r\n\r\n    const query = queries[category] || queries.all;\r\n    const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=ko&gl=KR&ceid=KR:ko`;\r\n\r\n    try {\r\n        // 정적 배포 환경 또는 개발 서버가 아닌 경우 직접 CORS 프록시 사용\r\n        if (isStaticDeployment()) {\r\n            const xmlText = await fetchWithCorsProxy(rssUrl);\r\n            return parseRSSFeed(xmlText);\r\n        }\r\n\r\n        // 개발 서버: Vite 프록시 사용\r\n        const response = await fetch(`/api/rss?url=${encodeURIComponent(rssUrl)}`);\r\n\r\n        if (!response.ok) {\r\n            throw new Error('RSS 피드 로드 실패');\r\n        }\r\n\r\n        const xmlText = await response.text();\r\n        return parseRSSFeed(xmlText);\r\n    } catch (error) {\r\n        logger.error('뉴스 로드 실패:', error);\r\n        // 최종 폴백: 데모 데이터 반환\r\n        return getDemoNewsWithCategory(category);\r\n    }\r\n};\r\n\r\n/**\r\n * 카테고리 필터링된 데모 뉴스 반환\r\n */\r\nfunction getDemoNewsWithCategory(category) {\r\n    if (category === 'all') {\r\n        return DEMO_NEWS;\r\n    }\r\n    return DEMO_NEWS.filter(news => news.category === category);\r\n}\r\n\r\n/**\r\n * RSS XML 파싱\r\n */\r\nfunction parseRSSFeed(xmlText) {\r\n    try {\r\n        const parser = new DOMParser();\r\n        const xml = parser.parseFromString(xmlText, 'text/xml');\r\n\r\n        // 파싱 오류 체크\r\n        const parseError = xml.querySelector('parsererror');\r\n        if (parseError) {\r\n            logger.error('RSS 파싱 오류:', parseError.textContent);\r\n            return DEMO_NEWS;\r\n        }\r\n\r\n        const items = xml.querySelectorAll('item');\r\n\r\n        if (items.length === 0) {\r\n            logger.warn('RSS 피드에 항목이 없음, 데모 데이터 사용');\r\n            return DEMO_NEWS;\r\n        }\r\n\r\n        const news = [];\r\n        items.forEach((item, index) => {\r\n            if (index >= 20) return; // 최대 20개\r\n\r\n            const title = item.querySelector('title')?.textContent || '';\r\n            const link = item.querySelector('link')?.textContent || '';\r\n            const pubDate = item.querySelector('pubDate')?.textContent || '';\r\n            const source = item.querySelector('source')?.textContent || '뉴스';\r\n            const description = item.querySelector('description')?.textContent || '';\r\n\r\n            // HTML 태그 제거\r\n            const cleanDescription = description.replace(/<[^>]*>/g, '').substring(0, 200);\r\n\r\n            // 날짜 파싱 안전 처리\r\n            let formattedDate;\r\n            try {\r\n                formattedDate = new Date(pubDate).toISOString().split('T')[0];\r\n            } catch {\r\n                formattedDate = new Date().toISOString().split('T')[0];\r\n            }\r\n\r\n            news.push({\r\n                id: index + 1,\r\n                title: title.replace(' - ' + source, ''),\r\n                summary: cleanDescription,\r\n                source,\r\n                date: formattedDate,\r\n                link,\r\n                category: categorizeNews(title),\r\n                sentiment: analyzeSentiment(title),\r\n            });\r\n        });\r\n\r\n        return news.length > 0 ? news : DEMO_NEWS;\r\n    } catch (error) {\r\n        logger.error('RSS 파싱 실패:', error);\r\n        return DEMO_NEWS;\r\n    }\r\n}\r\n\r\n/**\r\n * 뉴스 카테고리 자동 분류\r\n */\r\nfunction categorizeNews(title) {\r\n    const lowerTitle = title.toLowerCase();\r\n\r\n    if (lowerTitle.includes('정책') || lowerTitle.includes('규제') || lowerTitle.includes('법')) {\r\n        return 'policy';\r\n    }\r\n    if (lowerTitle.includes('전망') || lowerTitle.includes('분석') || lowerTitle.includes('예측')) {\r\n        return 'analysis';\r\n    }\r\n    if (lowerTitle.includes('재건축') || lowerTitle.includes('재개발') || lowerTitle.includes('gtx')) {\r\n        return 'development';\r\n    }\r\n    return 'market';\r\n}\r\n\r\n/**\r\n * 간단한 감성 분석\r\n */\r\nfunction analyzeSentiment(title) {\r\n    const positiveKeywords = ['상승', '호조', '활기', '급등', '회복', '호재', '증가', '최고'];\r\n    const negativeKeywords = ['하락', '급락', '침체', '위기', '폭락', '감소', '최저', '규제'];\r\n\r\n    const lowerTitle = title.toLowerCase();\r\n\r\n    for (const keyword of positiveKeywords) {\r\n        if (lowerTitle.includes(keyword)) return 'positive';\r\n    }\r\n    for (const keyword of negativeKeywords) {\r\n        if (lowerTitle.includes(keyword)) return 'negative';\r\n    }\r\n    return 'neutral';\r\n}\r\n\r\n/**\r\n * 네이버 부동산 뉴스 (Web Scraping 대안)\r\n */\r\nexport const fetchNaverRealEstateNews = async () => {\r\n    // 네이버 뉴스 API는 별도 인증 필요\r\n    // 대신 Google News RSS 사용\r\n    return fetchRealEstateNews('all');\r\n};\r\n"],"names":["CORS_PROXIES","url","fetchWithCorsProxy","timeout","controllers","fetchPromises","getProxyUrl","index","proxyUrl","controller","timeoutId","response","ctrl","i","error","logger","fetchRealEstateNews","category","queries","query","rssUrl","isStaticDeployment","xmlText","parseRSSFeed","getDemoNewsWithCategory","DEMO_NEWS","news","xml","parseError","items","item","title","_a","link","_b","pubDate","_c","source","_d","cleanDescription","_e","formattedDate","categorizeNews","analyzeSentiment","lowerTitle","positiveKeywords","negativeKeywords","keyword"],"mappings":"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"}